{% extends 'base.html.twig' %}

{% block title %}Calendrier{% endblock %}

{% block body %}
	<section id="about" class="padding">
		<div class="container aboutus">
			<div class="row">
				<div class="col-md-7 wow fadeInLeft" data-wow-delay="300ms">
					<h2 class="heading heading_space"><span>Calendrier des </span>évènements <span class="divider-left"></span></h2>
				</div>
			</div>
			<div class="margin10">
				<div class="widget heading_space">
					<div class="container">
						<div id="calendrier"></div>
					</div>
					<div class="row" style="column-gap: 10px">
						<a class="btn_common btn_border margin10 border_radius" href="{{ path('calendar_new') }}">
							Créer un évènement
						</a>
						<a class="btn_common btn_border margin10 border_radius" href="{{ path('home') }}">
							Retour
						</a>
					</div>
				</div>
			</div>
		</div>
	</section>
{% endblock %}
{% block javascripts %}
	<script>
		window.onload = () => {
			let calendarElt = document.querySelector("#calendrier");
			let xhr = new XMLHttpRequest();

			let calendar = new FullCalendar.Calendar(calendarElt, {
				themeSystem: 'bootstrap',
				initialView: 'dayGridMonth',
				locale: 'fr',
				timeZone : 'Europe/Paris',
				headerToolbar: {
					start: 'prev,next today',
					center: 'title',
					end: 'dayGridMonth,timeGridWeek'
				},
				events: {{ data|raw }},
				{% if is_granted('ROLE_DELEGATE') or  is_granted('ROLE_SPEAKER') %}
					editable: true,
					eventResizableFromStart: true,
					eventDurationEditable: true,
				{% endif %}

			});

			calendar.on('eventChange', (e) => {
				let url = `event/${e.event.id}/edit`
				let data = {
					"title": e.event.title,
					"description": e.event.extendedProps.description,
					"start": e.event.start,
					"end": e.event.end,
					"allDay": e.event.allDay,
					"backgroundColor": e.event.extendedProps.background_color,
					"borderColor": e.event.extendedProps.border_color,
					"textColor": e.event.extendedProps.text_color,
				}

				xhr.open("PUT", url);
				xhr.send(JSON.stringify(data));

			});

			calendar.on('eventClick', (e) => {
				let url;
				{% if is_granted('ROLE_DELEGATE') or  is_granted('ROLE_SPEAKER') %}
					url = `${e.event.id}/edit`;
				{% else %}
					url = `${e.event.id}`
				{% endif %}

				window.location.href = url;
			});

			calendar.render();
		}
	</script>
{% endblock %}
